/**
  * addExecRight v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
"use strict";var t=require("node:fs"),e=require("node:child_process");function n(t){return t.split(/\r?\n/).map((t=>t.trim())).filter((t=>t)).join("\n")}const i=(t,i,s)=>new Promise(((a,r)=>{s||(s=i,i=t,t="");const o=((t,e=" ")=>Array.isArray(t)?t.join(e):t)(i);(s.exec?s.exec:e.exec)(`${t=t?`${t} ${o}`:`${o}`}`,s,((t,e,i)=>{const{fixUnreadbleCode:o}=s;if(o){const{iconvDesEncoding:t,iconvSrcEncoding:n}=s;e&&(e=o(e,t,n)),i&&(i=o(i,t,n))}t&&s.exitWhenErr&&r(t),s.noTrimOut||(e=n(e),i=n(i)),s.rejectStderr&&(i&&r(t),a(e)),a({stdout:e,stderr:i})}))})),s={exec:e.exec},{log:a}=console;class r{constructor(t){this.init(t)}init(t){return this._max=t,this._count=0,this._taskQueue=[],this._debug=!1,this._cb=null,this}call(t,...e){return new Promise(((n,i)=>{const s=this._createTask(t,e,n,i);this._count>=this._max?this._taskQueue.push(s):s()}))}_createTask(t,e,n,i){return()=>{t(...e).then(n).catch(i).finally((()=>{this._next()})),this._nextTick()}}_next(){if(this._count-=1,this._taskQueue.length){this._taskQueue.shift()()}else this._debug&&a("task count = ",this._count),this._cb&&this._cb()}_nextTick(){this._count+=1,this._debug&&a("task count = ",this._count)}}new r;
/**
  * kindOf v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
const{toString:o}=Object.prototype,c=(l=Object.create(null),t=>{const e=o.call(t);return l[e]||(l[e]=e.slice(8,-1).toLowerCase())});var l;const{log:u}=console;function d(t){return function(...e){t&&u(...e)}}
/**
  * streamIo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
/**
  * textStreamIo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
class h{constructor(t="CHANGELO.md"){this.init(t)}async read(e=""){const{file:n}=this;let i,s;try{i=t.createReadStream(n.name),s=await(a=i,new Promise(((t,e)=>{let n="";a.on("data",(t=>{n+=t.toString()})).on("end",(()=>{t(n)})).on("error",e)})))}catch(t){s=e}var a;return n.data=s,s}async write(e){const{file:n,option:i}=this;let s,a,r;switch(s=t.createWriteStream(n.name),a=n.data,i.writemode){case"override":default:r=`${e}`;break;case"append":r=`${a}\n${e}`;break;case"head":r=`${e}\n${a}`}n.data=r,await function({stream:t,data:e}){return new Promise(((n,i)=>{t.write(e,"utf-8"),t.end(),t.on("finish",(()=>{n(e)})).on("error",i)}))}({stream:s,data:r})}init(t="CHANGELO.md",e=""){return this.file={name:t,data:e},this.option={},this}new(...t){return new h(...t)}}new h;const f=d(!0);module.exports=async function(e={}){const n={binPath:"bin",ext:".js,.sh",...e},a=d(n.logInfo);d(n.logTask)("[task] add exec rights to files"),a("[info] read file list");const o=n.binPath;let l=t.readdirSync(o).map((t=>`${o}/${t}`)).filter((e=>t.statSync(e).isFile()));if(a("[info] filter file list when ext passed"),n.ext){const{ext:t}=n,e=t.split(",").map((t=>new RegExp(`${t}$`)));l=l.filter((t=>e.some((e=>e.test(t)))))}const u=t=>async()=>{let e;t.onFileHead&&await async function(t={}){const e={fileHead:"#!/usr/bin/env node",...t};let n,i;const s=new h;s.init(e.loc),n=await s.read(""),n=n.split(/\r?\n/),[i]=n,i&&!/^#!/i.test(i)&&("del"===e.action?n.shift():n.unshift(e.fileHead));n=n.join("\n"),s.init(e.loc),await s.write(n)}({loc:t.file,...t.fileHead?{fileHead:t.fileHead}:{}});let n=`chmod +x ${t.file}`;return a(`[info] run: ${n}`),e=await i(n,s),t.updateByGit&&(n=`git update-index --chmod=+x ${t.file}`,a(`[info] run: ${n}`),e=await i(n,s)),e};let _;
/**
  * promiseAll v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
var m,w;let x;a("[info] gen task handle"),_=l.map((t=>u({...n,file:t}))),await(m=_,w=3,new Promise(((t,e)=>{const n=w||m.length,i=new r(n),s=[],a=e=>{let n=m[e];return"asyncfunction"===c(n)?n=n():"function"===c(n)&&(n=Promise.resolve(n())),n.then((t=>{i._debug?s[e]={index:e,data:t,state:"ok"}:s[e]=t}),(t=>{i._debug?s[e]={index:e,state:"no",error:t}:s[e]=t})).finally((()=>{i._cb=()=>{
//! this._taskQueue.length && this._count===0
0===i._count&&t(s)}}))};for(let t=0;t<m.length;t+=1)i.call(a,t)}))),n.verbose||(x=await i(`ls ${o} -l`,s),f(x))};
