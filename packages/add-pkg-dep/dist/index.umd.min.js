/**
  * addPkgDep v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node:fs"),require("node:module"),require("node:child_process")):"function"==typeof define&&define.amd?define(["node:fs","node:module","node:child_process"],t):(e="undefined"!=typeof globalThis?globalThis:e||self)["add-pkg-dep"]=t(e.node_fs,e.node_module,e.node_child_process)}(this,(function(e,t,n){"use strict";
/**
    * extendString v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */function i(e){return function(e){return e.replace(/(?:^\w|[A-Z_-]|\b\w)/g,((e,t)=>{let n="";return n=e.replace(/[-_]+/g," "),n=0!==t?n.replace(/[A-Z]/," $&"):n,0===t?n.toUpperCase():n.toLowerCase()})).replace(/\s+/g," ")}(e).replace(/(?:^\w|[A-Z]|\b\w)/g,((e,t)=>0===t?e.toLowerCase():e.toUpperCase())).replace(/\s+/g,"")}
/**
    * getCustomProp v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */function r(e,t,n,r={}){const o=function(e,t){let n=e;return t.prefix&&(n=`${t.prefix}${e}`),t.camelize&&(n=`${t.prefix}-${e}`,n=i(n)),n}(t,{prefix:"custom",camelize:!0,...r}),s=e[t]?e[t]:n;return e[o]?e[o]:s}
/**
    * getFileList v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */function o(e,t,n,r={}){const o={prefix:"custom",camelize:!0,override:!1,...r};if(o.override)return void(e[t]=n);const s=function(e,t){let n=e;return t.prefix&&(n=`${t.prefix}${e}`),t.camelize&&(n=`${t.prefix}-${e}`,n=i(n)),n}(t,o);e[s]=n}const s={};function c(e,t={}){const n={onlyName:!1,recursive:!0,...s,...t},i=r(n,"readdirSync"),o=r(n,"statSync");let a=i(e);return a=a.map((i=>{const r=`${e}/${i}`,s=o(r);return s.isFile()?n.onlyName?i:r:s.isDirectory()&&n.recursive?c(r,t):""})),a=a.flat(1),a}
/**
    * getNodeBuiltinModules v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */
/**
    * streamIo v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */
function a(e){return new Promise(((t,n)=>{let i="";e.on("data",(e=>{i+=e.toString()})).on("end",(()=>{t(i)})).on("error",n)}))}function l({stream:e,data:t}){return new Promise(((n,i)=>{e.write(t,"utf-8"),e.end(),e.on("finish",(()=>{n(t)})).on("error",i)}))}
/**
    * textStreamIo v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */o(s,"readdirSync",e.readdirSync,{override:!0}),o(s,"statSync",e.statSync,{override:!0});class p{constructor(e="CHANGELO.md"){this.init(e)}async read(t=""){const{file:n}=this;let i,r;try{i=e.createReadStream(n.name),r=await a(i)}catch(e){r=t}return n.data=r,r}async write(t){const{file:n,option:i}=this;let r,o,s;switch(r=e.createWriteStream(n.name),o=n.data,i.writemode){case"override":default:s=`${t}`;break;case"append":s=`${o}\n${t}`;break;case"head":s=`${t}\n${o}`}n.data=s,await l({stream:r,data:s})}init(e="CHANGELO.md",t=""){return this.file={name:e,data:t},this.option={},this}new(...e){return new p(...e)}}const u=new p;
/**
    * depParse v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */function d(...e){return[...e].map((e=>e.split(/\/?\\|\//))).flat(1/0).filter((e=>e)).join(d.sep?d.sep:"/")}function f(e={}){let t={};return Object.keys(e).forEach((n=>{void 0!==e[n]&&(t[n]=e[n])})),t}class m{constructor(){this.init()}init(){this.option={},this.filetext="",this.matchs=[],this.inLibDeps=[],this.outlibDeps=[],this.alldeps=[],this.deptree={},this.option.inlibdepReg=[/^\./,/@src/],this.option.parsetasks=["in","out"],this.option.nodedeps=["fs","path","os"]}async read(e){return u.init(e),this.filetext=await u.read(),this}delComment(){let{option:e,filetext:t}=this;const{commentReg:n,ignoreComment:i}=e;return t=function(e={}){const t={text:"",ignoreComment:!0,commentReg:[/\/\/.*/gi,/(\/)([*])+(.|\n)+?(\2\1)/gi],...e};let{text:n,commentReg:i}=t;return t.ignoreComment&&i.forEach((e=>{n=n.replace(e,"")})),n}(f({text:t,commentReg:n,ignoreComment:i})),this.filetext=t,this}getMatchs(){const{option:e,filetext:t}=this,n=function(e={}){const t={text:"",requireReg:[/require\(.*\)/gi,/from +("|').*("|')/gi,/import +("|').*("|')/gi],...e},{requireReg:n,text:i}=t;let r;return r=n.map((e=>{let t;return t=i.match(e),t})),r=r.filter((e=>e)),r=r.flat(1),r=[...new Set(r)],r=r.map((e=>{const t="";let i=e;return i.match(n[0])?i=i.replace(/require\(/,t).replace(/\)/,t):i.match(n[1])?i=i.replace(/from +/,t):i.match(n[2])&&(i=i.replace(/import +/,t)),i=i.replace(/^("|')/,t).replace(/("|')$/,t),i})),r=r.map((e=>{let t=1,n=e;return n.match(/^@/)&&(t+=1),n.match(/^.\//)||(n=n.split(/\//).slice(0,t).join("/")),n})),r}({text:t,...e});return this.matchs=n,n}getInLibDeps(){const{option:e,matchs:t}=this,{inlibdepReg:n}=e,i=function(e={}){const t={data:[""],localDepReg:[/^\./,/@src/],...e},{localDepReg:n,data:i}=t;let r;return r=i.filter((e=>n.some((t=>t.test(e))))),r}(f({data:t,localDepReg:n}));return this.inLibDeps=i,i}getOutlibDes(){const{option:e,matchs:t}=this,{inlibdepReg:n,nodedeps:i}=e,r=function(e={}){const t={localDep:[""],builintDep:[""],disableLocalDepReg:!1,...e},{data:n,localDep:i,localDepReg:r,builintDep:o}=t;let s;return s=[...n],t.disableLocalDepReg||(s=s.filter((e=>!r.some((t=>t.test(e)))))),i&&(s=c(s,i)),o&&(s=c(s,o)),s;function c(e,t){return function(e,t){return e.filter((e=>!t.some((t=>e===t))))}(e,t.filter((e=>"string"==typeof e)))}}(f({data:t,localDepReg:n,builintDep:i}));return this.outlibDeps=r,this}resolveInLibDeps(e){let t=this.inLibDeps;t=function(e={}){const t={data:[""],skipResolveReg:[/^@private-pkgs/,/^@/],...e},{skipResolveReg:n,fileloc:i}=t;let r=[...t.data];return r=r.map((e=>{if(n.some((t=>t.test(e))))return e;let t=d(function(e,t="/"){const n=e.split(/\/?\\|\//);return n.slice(0,n.length-1).join(t)}(i),e);return t=t.replace(/\\/gi,"/"),t})),r}({data:t,fileloc:e}),this.inLibDeps=t}async parse(e){const{option:t}=this,{parsetasks:n}=t;await this.read(e),this.delComment(),this.getMatchs(),n.includes("in")&&(this.getInLibDeps(),this.resolveInLibDeps(e)),n.includes("out")&&this.getOutlibDes();const{inLibDeps:i,outlibDeps:r}=this;return this.alldeps=[...i,...r],this.alldeps}}
/**
    * renderTpl v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */function h(e,t){let n=e;return Object.keys(t).forEach((e=>{const i=t[e];n=n.replace(new RegExp(`{${e}}`,"ig"),i)})),n}function g(e){return e.split(/\r?\n/).map((e=>e.trim())).filter((e=>e)).join("\n")}const b=(e,t,i)=>new Promise(((r,o)=>{i||(i=t,t=e,e="");const s=((e,t=" ")=>Array.isArray(e)?e.join(t):e)(t);(i.exec?i.exec:n.exec)(`${e=e?`${e} ${s}`:`${s}`}`,i,((e,t,n)=>{const{fixUnreadbleCode:s}=i;if(s){const{iconvDesEncoding:e,iconvSrcEncoding:r}=i;t&&(t=s(t,e,r)),n&&(n=s(n,e,r))}e&&i.exitWhenErr&&o(e),i.noTrimOut||(t=g(t),n=g(n)),i.rejectStderr&&(n&&o(e),r(t)),r({stdout:t,stderr:n})}))})),w={exec:n.exec};
/**
    * jsonStreamIo v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */
class y{constructor(e,t){this.init(e,t)}async read(t={}){const{file:n}=this;let i,r;try{i=e.createReadStream(n.name),r=await a(i),r=JSON.parse(r)}catch(e){r=t}return n.data=r,r}async write(t){const{file:n,option:i}=this;let r,o=t;try{r=e.createWriteStream(n.name),t?n.data=t:o=n.data,await l({stream:r,data:JSON.stringify(o,null,2)})}catch(e){}}init(e="package.json",t={}){this.file={name:e,data:t},this.option={}}new(...e){return new y(...e)}}new y;const{log:x}=console;return async function(e={}){const n={pkgLoc:"./pacakges/noop",pnpmCmd:"pnpm add --filter",pkgSrcLoc:"src",...e},{pkgLoc:r,pkgSrcLoc:o}=n,s=function(e,t="/"){const n=e.split(/\/?\\|\//);return n.slice(0,n.length-1).join(t)}(r),a=function(e,t={}){let n=function(e){const t=e.split(/\/?\\|\//);return t[t.length-1]}(e);const r={trim:!0,...t};return r.trim&&(n=n.trim()),r.camelize&&(n=i(n)),n}(r);x("[info] get file list at loc"),x(`[info] loc:${r}/${o} `);const l=c(`${r}/${o}`);x("[info] get nodejs built in module");const p=function(){const e=["sys"];return(t.builtinModules||(process.binding?Object.keys(process.binding("natives")):[])||[]).filter((t=>!/^_|^(internal|v8|node-inspect)\/|\//.test(t)&&!e.includes(t))).sort()}();x("[info] get dep list of out-lib at loc");const u=l.map((async e=>{const t=new m;return t.option.nodedeps=p,t.option.ignoreComment=!0,await t.parse(e),t.outlibDeps}));let d,f=await Promise.all(u);var g,y;
/**
    * runBash v0.0.3
    * (c) 2018-2022 ymc
    * @license MIT
    */f=[...new Set(f.flat(1))],x(f),f&&f.length>0&&(g=`${n.pnpmCmd} {libdir}/{libname} ${f.join(" ")}`,d=(y={libdir:s,libname:a})?h(g,y):e=>h(g,e),x(`[info] cmd:${d}`),await async function(e,t){const{stdout:n}=await b(e,t);return n}(d,w))}}));
