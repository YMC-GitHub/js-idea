/**
  * depParse v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
import{textstream as t}from"@ymc/text-stream-io";function e(...t){return[...t].map((t=>t.split(/\/?\\|\//))).flat(1/0).filter((t=>t)).join(e.sep?e.sep:"/")}function i(t={}){let e={};return Object.keys(t).forEach((i=>{void 0!==t[i]&&(e[i]=t[i])})),e}class s{constructor(){this.init()}init(){this.option={},this.filetext="",this.matchs=[],this.inLibDeps=[],this.outlibDeps=[],this.alldeps=[],this.deptree={},this.option.inlibdepReg=[/^\./,/@src/],this.option.parsetasks=["in","out"],this.option.nodedeps=["fs","path","os"]}async read(e){return t.init(e),this.filetext=await t.read(),this}delComment(){let{option:t,filetext:e}=this;const{commentReg:s,ignoreComment:n}=t;return e=function(t={}){const e={text:"",ignoreComment:!0,commentReg:[/\/\/.*/gi,/(\/)([*])+(.|\n)+?(\2\1)/gi],...t};let{text:i,commentReg:s}=e;return e.ignoreComment&&s.forEach((t=>{i=i.replace(t,"")})),i}(i({text:e,commentReg:s,ignoreComment:n})),this.filetext=e,this}getMatchs(){const{option:t,filetext:e}=this,i=function(t={}){const e={text:"",requireReg:[/require\(.*\)/gi,/from +("|').*("|')/gi,/import +("|').*("|')/gi],...t},{requireReg:i,text:s}=e;let n;return n=i.map((t=>{let e;return e=s.match(t),e})),n=n.filter((t=>t)),n=n.flat(1),n=[...new Set(n)],n=n.map((t=>{const e="";let s=t;return s.match(i[0])?s=s.replace(/require\(/,e).replace(/\)/,e):s.match(i[1])?s=s.replace(/from +/,e):s.match(i[2])&&(s=s.replace(/import +/,e)),s=s.replace(/^("|')/,e).replace(/("|')$/,e),s})),n=n.map((t=>{let e=1,i=t;return i.match(/^@/)&&(e+=1),i.match(/^.\//)||(i=i.split(/\//).slice(0,e).join("/")),i})),n}({text:e,...t});return this.matchs=i,i}getInLibDeps(){const{option:t,matchs:e}=this,{inlibdepReg:s}=t,n=function(t={}){const e={data:[""],localDepReg:[/^\./,/@src/],...t},{localDepReg:i,data:s}=e;let n;return n=s.filter((t=>i.some((e=>e.test(t))))),n}(i({data:e,localDepReg:s}));return this.inLibDeps=n,n}getOutlibDes(){const{option:t,matchs:e}=this,{inlibdepReg:s,nodedeps:n}=t,o=function(t={}){const e={localDep:[""],builintDep:[""],disableLocalDepReg:!1,...t},{data:i,localDep:s,localDepReg:n,builintDep:o}=e;let r;return r=[...i],e.disableLocalDepReg||(r=r.filter((t=>!n.some((e=>e.test(t)))))),s&&(r=l(r,s)),o&&(r=l(r,o)),r;function l(t,e){return function(t,e){return t.filter((t=>!e.some((e=>t===e))))}(t,e.filter((t=>"string"==typeof t)))}}(i({data:e,localDepReg:s,builintDep:n}));return this.outlibDeps=o,this}resolveInLibDeps(t){let i=this.inLibDeps;i=function(t={}){const i={data:[""],skipResolveReg:[/^@private-pkgs/,/^@/],...t},{skipResolveReg:s,fileloc:n}=i;let o=[...i.data];return o=o.map((t=>{if(s.some((e=>e.test(t))))return t;let i=e(function(t,e="/"){const i=t.split(/\/?\\|\//);return i.slice(0,i.length-1).join(e)}(n),t);return i=i.replace(/\\/gi,"/"),i})),o}({data:i,fileloc:t}),this.inLibDeps=i}async parse(t){const{option:e}=this,{parsetasks:i}=e;await this.read(t),this.delComment(),this.getMatchs(),i.includes("in")&&(this.getInLibDeps(),this.resolveInLibDeps(t)),i.includes("out")&&this.getOutlibDes();const{inLibDeps:s,outlibDeps:n}=this;return this.alldeps=[...s,...n],this.alldeps}}export{s as default};
