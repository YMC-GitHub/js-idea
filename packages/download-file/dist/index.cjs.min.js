/**
  * downloadFile v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
"use strict";var e=require("node:fs"),t=require("node:https");const{log:n}=console;function s(t){const{response:n,data:s,stream:o,targetFile:r,resolve:i}=t;let a;o?a=o:(!function(t){const n=function(e,t={}){const{split:n,splitReg:s}={splitReg:/\/|\\/,split:"/",...t};let o=e.split(s||n);const{length:r}=o;return r>1?(o=o.slice(0,r-1),o=o.join(n)):o="",o}(t);n&&"."!==n&&".."!==n&&e.mkdirSync(n,{recursive:!0})}(r),a=e.createWriteStream(r)),a.on("finish",(()=>{i(s)})),n.pipe(a)}module.exports=async function o(r,i={}){let a;a="string"==typeof i?{targetFile:i}:{...i};const{targetFile:l,overideTargetFile:c}=a;if(c||!e.existsSync(l))return await new Promise(((e,i)=>{let c=t.request;(function(e){return"function"==typeof e})(a.customRequest)&&(c=a.customRequest);const u=c(r,a,(t=>{const r=t.statusCode??0;if(r>=400)return n("[info] get response state"),n(r,t.statusMessage),i(new Error(t.statusMessage));if(r>300&&r<400&&t.headers.location)return o(t.headers.location,l);const c=function(e={}){const{len:t}=e,n=t/1048576;return{...e,len:t,cur:0,total:n}}({len:parseInt(t.headers["content-length"],10),file:l||t.url});let u="";t.on("data",(e=>{!function(e,t){e.cur+=t.length}(c,e),a.showProgress&&function(e){const{file:t,cur:s,len:o,total:r}=e,i=(100*s/o).toFixed(2),a=(s/1048576).toFixed(2),l=r.toFixed(2);n(`[process] downloading ${t} - ${i} % (${a} MB ) of total size: ${l}MB`)}(c),u+=e})),t.on("end",(()=>{a.showProgress&&n("[process] download complete"),l||e(u)})),l&&s({targetFile:l,resolve:e,response:t,data:u})})).on("error",(e=>{i(e)}));a.data&&u.write(a.data),u.end()}));n(`[info] target file ${l} exsits`)};
