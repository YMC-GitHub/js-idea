/**
  * downloadFile v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
import{createWriteStream as t,mkdirSync as e,existsSync as o}from"node:fs";import{request as n}from"node:https";const{log:s}=console;function r(o){const{response:n,data:s,stream:r,targetFile:i,resolve:l}=o;let a;r?a=r:(!function(t){const o=function(t,e={}){const{split:o,splitReg:n}={splitReg:/\/|\\/,split:"/",...e};let s=t.split(n||o);const{length:r}=s;return r>1?(s=s.slice(0,r-1),s=s.join(o)):s="",s}(t);o&&"."!==o&&".."!==o&&e(o,{recursive:!0})}(i),a=t(i)),a.on("finish",(()=>{l(s)})),n.pipe(a)}async function i(t,e={}){let l;l="string"==typeof e?{targetFile:e}:{...e};const{targetFile:a,overideTargetFile:c}=l;if(c||!o(a))return await new Promise(((e,o)=>{let c=n;(function(t){return"function"==typeof t})(l.customRequest)&&(c=l.customRequest);const u=c(t,l,(t=>{const n=t.statusCode??0;if(n>=400)return s("[info] get response state"),s(n,t.statusMessage),o(new Error(t.statusMessage));if(n>300&&n<400&&t.headers.location)return i(t.headers.location,a);const c=function(t={}){const{len:e}=t,o=e/1048576;return{...t,len:e,cur:0,total:o}}({len:parseInt(t.headers["content-length"]||1,10),file:a||t.url});let u="";t.on("data",(t=>{!function(t,e){t.cur+=e.length}(c,t),l.showProgress&&function(t){const{file:e,cur:o,len:n,total:r}=t,i=(100*o/(1===n?o:n)).toFixed(2),l=(o/1048576).toFixed(2),a=1===n?l:r.toFixed(2);s(`[process] downloading ${e} - ${i} % (${l} MB ) of total size: ${a}MB`)}(c),u+=t})),t.on("end",(()=>{l.showProgress&&s("[process] download complete"),a||e(u)})),a&&r({targetFile:a,resolve:e,response:t,data:u})})).on("error",(t=>{o(t)}));l.data&&u.write(l.data),u.end()}));s(`[info] target file ${a} exsits`)}export{i as default};
