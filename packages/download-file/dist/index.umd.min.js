/**
  * downloadFile v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node:fs"),require("node:https")):"function"==typeof define&&define.amd?define(["node:fs","node:https"],t):(e="undefined"!=typeof globalThis?globalThis:e||self)["download-file"]=t(e.node_fs,e.node_https)}(this,(function(e,t){"use strict";const{log:n}=console;function o(t){const{response:n,data:o,stream:s,targetFile:i,resolve:r}=t;let l;s?l=s:(!function(t){const n=function(e,t={}){const{split:n,splitReg:o}={splitReg:/\/|\\/,split:"/",...t};let s=e.split(o||n);const{length:i}=s;return i>1?(s=s.slice(0,i-1),s=s.join(n)):s="",s}(t);n&&"."!==n&&".."!==n&&e.mkdirSync(n,{recursive:!0})}(i),l=e.createWriteStream(i)),l.on("finish",(()=>{r(o)})),n.pipe(l)}return async function s(i,r={}){let l;l="string"==typeof r?{targetFile:r}:{...r};const{targetFile:a,overideTargetFile:c}=l;if(c||!e.existsSync(a))return await new Promise(((e,r)=>{let c=t.request;(function(e){return"function"==typeof e})(l.customRequest)&&(c=l.customRequest);const u=c(i,l,(t=>{const i=t.statusCode??0;if(i>=400)return n("[info] get response state"),n(i,t.statusMessage),r(new Error(t.statusMessage));if(i>300&&i<400&&t.headers.location)return s(t.headers.location,a);const c=function(e={}){const{len:t}=e,n=t/1048576;return{...e,len:t,cur:0,total:n}}({len:parseInt(t.headers["content-length"]||1,10),file:a||t.url});let u="";t.on("data",(e=>{!function(e,t){e.cur+=t.length}(c,e),l.showProgress&&function(e){const{file:t,cur:o,len:s,total:i}=e,r=(100*o/(1===s?o:s)).toFixed(2),l=(o/1048576).toFixed(2),a=1===s?l:i.toFixed(2);n(`[process] downloading ${t} - ${r} % (${l} MB ) of total size: ${a}MB`)}(c),u+=e})),t.on("end",(()=>{l.showProgress&&n("[process] download complete"),a||e(u)})),a&&o({targetFile:a,resolve:e,response:t,data:u})})).on("error",(e=>{r(e)}));l.data&&u.write(l.data),u.end()}));n(`[info] target file ${a} exsits`)}}));
