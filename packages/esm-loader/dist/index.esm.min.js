/**
  * esmLoader v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
import{resolve as t,sep as e,extname as n}from"node:path";import{URL as r}from"node:url";import{createReadStream as s,createWriteStream as i,readFileSync as a}from"node:fs";
/**
  * streamIo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */function o(t){return new Promise(((e,n)=>{let r="";t.on("data",(t=>{r+=t.toString()})).on("end",(()=>{e(r)})).on("error",n)}))}function c({stream:t,data:e}){return new Promise(((n,r)=>{t.write(e,"utf-8"),t.end(),t.on("finish",(()=>{n(e)})).on("error",r)}))}
/**
  * jsonStreamIo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */class l{constructor(t,e){this.init(t,e)}async read(t={}){const{file:e}=this;let n,r;try{n=s(e.name),r=await o(n),r=JSON.parse(r)}catch(e){r=t}return e.data=r,r}async write(t){const{file:e,option:n}=this;let r,s=t;try{r=i(e.name),t?e.data=t:s=e.data,await c({stream:r,data:JSON.stringify(s,null,2)})}catch(t){}}init(t="package.json",e={}){this.file={name:t,data:e},this.option={}}new(...t){return new l(...t)}}const f=new l;
/**
  * textStreamIo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */class u{constructor(t="CHANGELO.md"){this.init(t)}async read(t=""){const{file:e}=this;let n,r;try{n=s(e.name),r=await o(n)}catch(e){r=t}return e.data=r,r}async write(t){const{file:e,option:n}=this;let r,s,a;switch(r=i(e.name),s=e.data,n.writemode){case"override":default:a=`${t}`;break;case"append":a=`${s}\n${t}`;break;case"head":a=`${t}\n${s}`}e.data=a,await c({stream:r,data:a})}init(t="CHANGELO.md",e=""){return this.file={name:t,data:e},this.option={},this}new(...t){return new u(...t)}}const d=new u;
/**
  * compareVersion v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */function m(t,e){const n=`${e}`;let r=[];if(t){let t=n.split("-")[1];r=n.split("-")[0].split("."),t=t.split("."),r=r.concat(t)}else r=n.split(".");return r}function p(t){return t.map((t=>Number.isNaN(t)?t:parseInt(t)))}function h(t,e){const n=`${t}`,r=`${e}`,s=n.indexOf("-")>-1,i=r.indexOf("-")>-1;let a=m(s,n),o=m(i,r);a=p(a),o=p(o);const c=Math.max(a.length,o.length);for(let t=0;t<c;t+=1){if(3===t&&(void 0===a[t]||void 0===o[t])){if(void 0===a[t]&&Number.isNaN(o[t]))return 1;if(Number.isNaN(a[t])&&void 0===o[t])return-1}if(void 0===a[t])return-1;if(void 0===o[t])return 1;if(a[t]>o[t])return 1;if(a[t]<o[t])return-1}return 0}function w(e,n){const r=function(e){const n=t(process.cwd(),"."),{alias:r={}}=e;return Object.keys(r).forEach((e=>{const s=r[e];r[e]=function(t,e=".",n=/^<root>/i){return t.replace(n,e)}(s),r[e]=t(n,r[e])})),r}(n),s=Object.keys(r);for(let t=0;t<s.length;t+=1){const n=s[t],i=r[n];if(e.startsWith(n)){const t=new RegExp(`^${n}`),r=e.replace(t,"");e=`file:///${e=(e=`${i}/${r}`).replace(/\\/gi,"/")}`}}return e}const{log:g}=console,y=function(t="module-alias.json"){return function(t,e={}){let n;try{n=a(t),n=JSON.parse(n)}catch(t){n=e}return n}(t,{})}(),v=h(process.version,"14.13.1")>=0||h(process.version,"12.20.0")>=0;function $(t){$.enable&&g(t)}async function N(t,e,r,s){if($("[info] compact node lib expression"),!v&&t.startsWith("node:")&&(t=t.slice(5)),$("[info] reslove alias"),t=w(t,y),$("[info] reslove dirs"),t.endsWith("/"))return await x(t,e,r);let i;$("[info] reslove next");try{i=await r(t,e,r)}catch(n){if(n instanceof Error&&!s){if("ERR_UNSUPPORTED_DIR_IMPORT"===n.code)return $("[info] recursive reslove dirs"),await x(t,e,r);if("ERR_MODULE_NOT_FOUND"===n.code)return $("[info] recursive reslove exts"),await j(t,e,r)}throw n}if(i.url.endsWith(".json"))return{...i,format:"json"};let{format:a}=i;if(i.url.startsWith("file://")){a=function(t){const e=n(t);if(".mjs"===e||".mts"===e)return"module";if(".cjs"===e||".cts"===e)return"commonjs"}(i.url)||a}return{...i,format:a}}async function j(t,e,n){const r=[".js",".json",".ts",".tsx",".jsx"],{extensions:s=r}=e;let i,a;for(const r of s)try{return $(`[info] try reslove ${t+r}`),i=await n(t+r,e,n),i}catch(t){if(void 0===a){const{message:e}=t;t.message=t.message.replace(`${r}'`,"'"),t.stack=t.stack.replace(e,t.message),a=t}}throw a}async function x(t,n,r){let s;if(s=await async function(t,e,n){let r;$("[info] try resolve module,main,browser and other key in package.json");const s=await async function(t,e,n){const{packagejsonIndexOrder:r="jsnext -> browser"}=e,s=t.endsWith("/");let i,a,o,c;i="package.json",a=s?t+i:`${t}/${i}`,a=a.replace("file:///",""),f.init(a),o=await f.read({}),c=[o.main,o.module],"module"===o.type&&(c=[o.module,o.main]);c=[...c,...l(r)],c=c.filter((t=>t)),s||(c=c.map((t=>`/${t}`)));return c;function l(t="module -> main",e=/ ?-> ?/){return t.split(e).filter((t=>t)).map((t=>o[t])).filter((t=>t))}}(t,e);let i;if(s.length<0)return r;for(const a of s)try{return $(`[info] try resolve ${t+a}`),r=await n(t+a,e,n),r}catch(t){if(void 0===i){const{message:e}=t;t.message=t.message.replace(`${a}'`,"'"),t.stack=t.stack.replace(e,t.message),i=t}throw i}}(t,n,r),s)return s;let i="index";const a=t.endsWith("/")?i:"/index";try{return s=await j(t+a,n,r),s}catch(t){const{message:n}=t;throw t.message=t.message.replace(`${a.replace("/",e)}'`,"'"),t.stack=t.stack.replace(n,t.message),t}}async function O(t,e,n){const s=t.split("?")[0];return[".md",".css",".html",".htm",".svg"].some((t=>s.endsWith(t)))?await async function(t){d.init(new r(t));const e=await d.read("");return{format:"module",source:`export default ${JSON.stringify(e.toString())};`,shortCircuit:!0}}(t):n(t,e,n)}$.enable=!1;export{O as load,N as resolve};
