#!/usr/bin/env node
/**
  * jcm v0.0.1
  * (c) 2018-2022 ymc
  * @license MIT
  */
import{rmdirSync as t,existsSync as e,mkdirSync as n,readFileSync as s,writeFileSync as o}from"fs";import{dirname as i,parse as r,join as l}from"path";const a=(t,e="")=>{const n=new RegExp(` *${t}:.*`,"ig"),s=e.match(n);return s?s[0].replace(new RegExp(` *${t}:`,"i"),""):""},{log:c}=console;class u{constructor(){this.list=[],this.index=-1,this.freeze=!1}use(t={},e){let{list:n,index:s}=this;const o=!e;return o||s==e?s++:s<e&&(s=e),this.index=s,s=o?s:e,t&&(n[s]=t),this}load(){const{list:t}=this;let e={};for(let n=0;n<t.length;n++){const s=t[n];s&&(e={...e,...s})}const{freeze:n}=this;return n?Object.freeze(e):e}}class d{constructor(){this.data={},this.option={splitChar:"."}}bind(t){return t&&(this.data=t),this}split(t="."){return t&&(this.option.splitChar=t),this}conf(t="",e){if(!t)return this;let n,{data:s,option:o}=this;n=(t=t.split(o.splitChar))[t.length-1];const{length:i}=t;for(let e=0;e<i-1;e++){const n=t[e];s[n]||(s[n]={}),s=s[n]}return null==e?s[n]:(s[n]=e,c(`set ${n} ${e}`),this)}}new u,new d;const{log:h}=console;const f=new class{constructor(){this.option={},this.tool={}}getFileLoc(t){let{option:e,tool:n}=this,s=t||e.name,o=e;return o.usd||o.u?n.joinPath(n.getUserHome(),s):o.crd||o.c?s:o.wkd?(h(s,e),n.joinPath(o.wkd,s)):s}getFileLocList(t){let e=[],{option:n}=this;return e=[["usd","u"],["crd","c"],["wkd"]].map((e=>{let s,o,i;for(let t=0;t<e.length;t++){const r=e[t];if(n[r]){o=n[r],s=r,i=!0;break}}return!!i&&(this.option={[`${s}`]:o,name:n.name},this.getFileLoc(t))})).filter((t=>t)),this.option=n,e}magicReadConfig(t=".ymcrc.json"){let{tool:e}=this;return function(t=[".ymcrc.json"],e){const n=new u;for(let s=0;s<t.length;s++){const o=t[s];n.use(e(o))}return n.load()}(this.getFileLocList(t),e.readJson)}magicDefineConfig(t,e,n){const s=new d;return s.bind(t),s.split("/"),s.conf(e,n),s.data}getJsonVal(t="key",e="val"){let n,{data:s}=this;if(t)return n=s[e],h(n),n}setJsonVal(t,e,n){let s,o,{option:i,tool:r}=this,l=this,{name:a}=i;s=l.magicReadConfig(a),t&&n&&(s=l.magicDefineConfig(s,t,e)),o=l.getFileLocList(a),o=o[o.length-1];let c=r.parsePath(o).dir;c&&r.addDirs(c),i.dryrun||r.saveJson(o,s),this.data=s}comEntry(t){let e,n,s,{option:o,tool:i}=this,{name:r}=o,l={};if("cnf"==t){let i=Object.keys(o),r="name|wkd|usd|crd|w|u|c".split("|");e=i.filter((t=>!r.includes(t)))[0],n=o[e],s=e in o,t=s?"add":"get"}else e=o.key,n=o.val,s="val"in o;switch(t){case"add":this.setJsonVal(e,n,s);break;case"del":break;default:l=this.magicReadConfig(r),this.getJsonVal(e,n),h("[info] info data:"),h(l)}return l}};const g=function t(s){return!!e(s)||(t(i(s))?(n(s),!0):void 0)},p=t;function b(t,e={}){let n;try{n=s(t),n=JSON.parse(n)}catch(t){n=e}return n}function m(t,e){o(t,JSON.stringify(e,null,2))}function v(){return process.env["win32"==process.platform?"USERPROFILE":"HOME"]}const{log:y}=console,w={name:".ymcrc.json",wkd:"packages/noop",usd:!1,crd:!0},S=(t={})=>{S.debug&&y("[info] run cmd with: ns"),S.debug&&y("[info] hello ns"),S.debug&&y("[info] log cli option:"),S.debug&&y(t)},$=(t="add")=>(e={})=>{let n;if(S.debug&&y(`[info] run cmd with: ns ${t}`),S.debug&&y(`[info] hello ${t}`),w.wkd="",n=S.notOnlyFlags?{...w,...e.flags}:{...w,...e},S.debug&&y("[info] log now flags:"),S.debug&&y(n),f.option=n,f.tool={parsePath:r,joinPath:l,addDirs:g,delDirs:p,readJson:b,saveJson:m,getUserHome:v},"loc"==t){let t=f.getFileLocList();return y("[info] cnf file list:"),y(t),y("[info] the last file:"),void y(t[t.length-1])}return f.comEntry(t)},C=new class{constructor(){}entrys(t){return t?(this.context=t,this):this.context}bind(t="",e=(()=>{}),n=""){const s=this.entrys();t.split("|").forEach((t=>{let o;if("call"===n.toLowerCase())o=e(t);s[t]=o}))}};C.entrys(S).bind("add|del|put|get",$,"call"),C.entrys(S).bind("loc|cnf",$,"call");const O=((t="ns")=>`cnf gen for ymc repo\n  mgnt cnf file\n  usage:ns [subcmd] [option]\n    ${t} -h\n    ${t} -v\n\n  subns:loc|cnf\n  subcmd:add|del|get\n    add - add des file\n    del - del des file\n    get - get des file\n  option:\n    -n,--name <filename> cnf file name (default:.ymcrc.json )\n    -w,--wkd <dir> set working(packages/libname) dir\n    -u,--usd use user dir\n    -c,--crd use current(project) dir\n    -h,--help get help\n    -v,--version get version\n`)("jcm"),k=((t="npm-bin",e="1.0.0",n="")=>{let s={};return s={...s,version:e,ns:t,autoSubCmd:a("subcmd",n),autoSubNs:a("subns",n)},s})("jcm","1.0.0",O);S.usage=O,S.option=k,S.cnf.enableZeroOption=!0,S.enableZeroOption=!0,S.notOnlyFlags=!0,S.debug=!0;const x=t=>!!["true",!0].includes(t)||!["false",!1].includes(t)&&(Number(t)?Number(t):t),{log:N}=console;const j=new class{constructor(){this.option={helpmsg:"usage:ns option",argvIndexS:2,enbaleSubCmd:!1,subcmd:"",allowAutoSubCmd:!0,autoSubCmd:"",version:"1.0.0",ns:"ycs",enbaleSubNs:!1,subns:"",allowAutoSubNs:!0,autoSubNs:""}}ns(t="ns"){return this.option.ns=t,this}version(t="1.0.0"){return this.option.version=t,this}entry(t={}){return this.option.entrys=t,this}autosubcmd(t=""){return this.option.autoSubCmd=t,this}autosubns(t=""){return this.option.autoSubNs=t,this}nanoparse(t=(()=>{})){return this.option.nanoparse=t,this}run(t){let{entrys:e,helpmsg:n,argvIndexS:s,enbaleSubCmd:o,subcmd:i,allowAutoSubCmd:r,autoSubCmd:l,version:a,ns:c,enbaleSubNs:u,subns:d,allowAutoSubNs:h,autoSubNs:f}=this.option;!u&&h&&f&&(f=Array.isArray(f)?f:f.split("|"),u=f.includes(t[s])),u&&(d=t[s],s++,n=n.replace(/option$/,"subns option")),!o&&r&&l&&(l=Array.isArray(l)?l:l.split("|"),o=l.includes(t[s])),o&&(i=t[s],s++,n=n.replace(/option$/,"subcmd option"));let g=e;if(n=e.usage,u&&d){if(!g[d])return N(`${n}`),void N(`todo:subns:${d}`);n=g[d].usage?g[d].usage:n,a=g[d].version?g[d].version:a,g=g[d]?g[d]:()=>{}}if(o&&i){if(!g[i])return N(`${n}`),void N(`todo:subcmd:${i}`);n=g[i].usage?g[i].usage:n,a=g[i].version?g[i].version:a,g=g[i]?g[i]:()=>{}}let p=t.length<=s;if(e.enableZeroOption&&(p=t.length<s),g.enableZeroOption&&(p=t.length<s),p)return N(`${n}`),void N("error:invalid argv length");const b=function(t){let e=[],n=t;const s=[];t.includes("--")&&(e=t.slice(t.indexOf("--")+1),n=t.slice(0,t.indexOf("--")));const o=[];for(let t=0;t<n.length;t++){const e=n[t-1],i=n[t],r=n[t+1],l=r&&!/^--.+/.test(r)&&!/^-.+/.test(r),a=t=>{o.push([t,!l||r])};if(/^--.+=/.test(i)||/^-.=/.test(i))o.push(i.split("="));else if(/^-[^-].*/.test(i)){let t=i;if(t.includes("=")){const e=t.indexOf("=");o.push([t.slice(e-1,e),t.slice(e+1,e+2)]),t=t.slice(0,e-1)+t.slice(e+2)}for(const e of t.slice(1).split("").slice(0,-1))o.push([e,!0]);a(t[t.length-1])}else if(/^--.+/.test(i)||/^-.+/.test(i))a(i);else{let t=o.find((t=>t[0]===e));if(!t&&/^-./.test(e)){const n=e[e.length-1];t=o.find((t=>t[0]===n))}t||s.push(i)}}const i={};for(const t of o){let e=t[0].replace(/^-{1,2}/g,""),n=t[1];e.startsWith("no-")&&[void 0,!0].includes(n)&&(e=e.slice(3),n=!1),i[e]=x(n)}return{flags:i,_:s.map((t=>x(t))),extras:e.map((t=>x(t)))}}(t.slice(s)),m=b.flags;if((m.debugArgs||m.da)&&N(b),m.version||m.v)N(`${c} version:${a}`);else{if(!m.help&&!m.h)return e.notOnlyFlags||g.notOnlyFlags?g(b):g(m);N(`${n}`)}}};((t={})=>e=>(t.option&&(e.option={...e.option,...t.option}),"version,ns,autoSubCmd,autoSubNs".split(",").forEach((n=>{t[n]&&(e.option[n]=t[n])})),e.entry(t),e))(S)(j),j.run(process.argv);
