#!/usr/bin/env node
/**
  * jcm v0.0.1
  * (c) 2018-2022 ymc
  * @license MIT
  */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("fs"),require("path")):"function"==typeof define&&define.amd?define(["fs","path"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).fs,t.path)}(this,(function(t,e){"use strict";const n=(t,e="")=>{const n=new RegExp(` *${t}:.*`,"ig"),s=e.match(n);return s?s[0].replace(new RegExp(` *${t}:`,"i"),""):""},{log:s}=console;class o{constructor(){this.list=[],this.index=-1,this.freeze=!1}use(t={},e){let{list:n,index:s}=this;const o=!e;return o||s==e?s++:s<e&&(s=e),this.index=s,s=o?s:e,t&&(n[s]=t),this}load(){const{list:t}=this;let e={};for(let n=0;n<t.length;n++){const s=t[n];s&&(e={...e,...s})}const{freeze:n}=this;return n?Object.freeze(e):e}}class i{constructor(){this.data={},this.option={splitChar:"."}}bind(t){return t&&(this.data=t),this}split(t="."){return t&&(this.option.splitChar=t),this}conf(t="",e){if(!t)return this;let n,{data:o,option:i}=this;n=(t=t.split(i.splitChar))[t.length-1];const{length:r}=t;for(let e=0;e<r-1;e++){const n=t[e];o[n]||(o[n]={}),o=o[n]}return null==e?o[n]:(o[n]=e,s(`set ${n} ${e}`),this)}}new o,new i;const{log:r}=console;const l=new class{constructor(){this.option={},this.tool={}}getFileLoc(t){let{option:e,tool:n}=this,s=t||e.name,o=e;return o.usd||o.u?n.joinPath(n.getUserHome(),s):o.crd||o.c?s:o.wkd?(r(s,e),n.joinPath(o.wkd,s)):s}getFileLocList(t){let e=[],{option:n}=this;return e=[["usd","u"],["crd","c"],["wkd"]].map((e=>{let s,o,i;for(let t=0;t<e.length;t++){const r=e[t];if(n[r]){o=n[r],s=r,i=!0;break}}return!!i&&(this.option={[`${s}`]:o,name:n.name},this.getFileLoc(t))})).filter((t=>t)),this.option=n,e}magicReadConfig(t=".ymcrc.json"){let{tool:e}=this;return function(t=[".ymcrc.json"],e){const n=new o;for(let s=0;s<t.length;s++){const o=t[s];n.use(e(o))}return n.load()}(this.getFileLocList(t),e.readJson)}magicDefineConfig(t,e,n){const s=new i;return s.bind(t),s.split("/"),s.conf(e,n),s.data}getJsonVal(t="key",e="val"){let n,{data:s}=this;if(t)return n=s[e],r(n),n}setJsonVal(t,e,n){let s,o,{option:i,tool:r}=this,l=this,{name:c}=i;s=l.magicReadConfig(c),t&&n&&(s=l.magicDefineConfig(s,t,e)),o=l.getFileLocList(c),o=o[o.length-1];let a=r.parsePath(o).dir;a&&r.addDirs(a),i.dryrun||r.saveJson(o,s),this.data=s}comEntry(t){let e,n,s,{option:o,tool:i}=this,{name:l}=o,c={};if("cnf"==t){let i=Object.keys(o),r="name|wkd|usd|crd|w|u|c".split("|");e=i.filter((t=>!r.includes(t)))[0],n=o[e],s=e in o,t=s?"add":"get"}else e=o.key,n=o.val,s="val"in o;switch(t){case"add":this.setJsonVal(e,n,s);break;case"del":break;default:c=this.magicReadConfig(l),this.getJsonVal(e,n),r("[info] info data:"),r(c)}return c}};const c=function n(s){return!!t.existsSync(s)||(n(e.dirname(s))?(t.mkdirSync(s),!0):void 0)},a=t.rmdirSync;function u(e,n={}){let s;try{s=t.readFileSync(e),s=JSON.parse(s)}catch(t){s=n}return s}function d(e,n){t.writeFileSync(e,JSON.stringify(n,null,2))}function f(){return process.env["win32"==process.platform?"USERPROFILE":"HOME"]}const{log:h}=console,p={name:".ymcrc.json",wkd:"packages/noop",usd:!1,crd:!0},g=(t={})=>{g.debug&&h("[info] run cmd with: ns"),g.debug&&h("[info] hello ns"),g.debug&&h("[info] log cli option:"),g.debug&&h(t)},b=(t="add")=>(n={})=>{let s;if(g.debug&&h(`[info] run cmd with: ns ${t}`),g.debug&&h(`[info] hello ${t}`),p.wkd="",s=g.notOnlyFlags?{...p,...n.flags}:{...p,...n},g.debug&&h("[info] log now flags:"),g.debug&&h(s),l.option=s,l.tool={parsePath:e.parse,joinPath:e.join,addDirs:c,delDirs:a,readJson:u,saveJson:d,getUserHome:f},"loc"==t){let t=l.getFileLocList();return h("[info] cnf file list:"),h(t),h("[info] the last file:"),void h(t[t.length-1])}return l.comEntry(t)},m=new class{constructor(){}entrys(t){return t?(this.context=t,this):this.context}bind(t="",e=(()=>{}),n=""){const s=this.entrys();t.split("|").forEach((t=>{let o;if("call"===n.toLowerCase())o=e(t);s[t]=o}))}};m.entrys(g).bind("add|del|put|get",b,"call"),m.entrys(g).bind("loc|cnf",b,"call");const y=((t="ns")=>`cnf gen for ymc repo\n  mgnt cnf file\n  usage:ns [subcmd] [option]\n    ${t} -h\n    ${t} -v\n\n  subns:loc|cnf\n  subcmd:add|del|get\n    add - add des file\n    del - del des file\n    get - get des file\n  option:\n    -n,--name <filename> cnf file name (default:.ymcrc.json )\n    -w,--wkd <dir> set working(packages/libname) dir\n    -u,--usd use user dir\n    -c,--crd use current(project) dir\n    -h,--help get help\n    -v,--version get version\n`)("jcm"),v=((t="npm-bin",e="1.0.0",s="")=>{let o={};return o={...o,version:e,ns:t,autoSubCmd:n("subcmd",s),autoSubNs:n("subns",s)},o})("jcm","1.0.0",y);g.usage=y,g.option=v,g.cnf.enableZeroOption=!0,g.enableZeroOption=!0,g.notOnlyFlags=!0,g.debug=!0;const w=t=>!!["true",!0].includes(t)||!["false",!1].includes(t)&&(Number(t)?Number(t):t),{log:S}=console;const $=new class{constructor(){this.option={helpmsg:"usage:ns option",argvIndexS:2,enbaleSubCmd:!1,subcmd:"",allowAutoSubCmd:!0,autoSubCmd:"",version:"1.0.0",ns:"ycs",enbaleSubNs:!1,subns:"",allowAutoSubNs:!0,autoSubNs:""}}ns(t="ns"){return this.option.ns=t,this}version(t="1.0.0"){return this.option.version=t,this}entry(t={}){return this.option.entrys=t,this}autosubcmd(t=""){return this.option.autoSubCmd=t,this}autosubns(t=""){return this.option.autoSubNs=t,this}nanoparse(t=(()=>{})){return this.option.nanoparse=t,this}run(t){let{entrys:e,helpmsg:n,argvIndexS:s,enbaleSubCmd:o,subcmd:i,allowAutoSubCmd:r,autoSubCmd:l,version:c,ns:a,enbaleSubNs:u,subns:d,allowAutoSubNs:f,autoSubNs:h}=this.option;!u&&f&&h&&(h=Array.isArray(h)?h:h.split("|"),u=h.includes(t[s])),u&&(d=t[s],s++,n=n.replace(/option$/,"subns option")),!o&&r&&l&&(l=Array.isArray(l)?l:l.split("|"),o=l.includes(t[s])),o&&(i=t[s],s++,n=n.replace(/option$/,"subcmd option"));let p=e;if(n=e.usage,u&&d){if(!p[d])return S(`${n}`),void S(`todo:subns:${d}`);n=p[d].usage?p[d].usage:n,c=p[d].version?p[d].version:c,p=p[d]?p[d]:()=>{}}if(o&&i){if(!p[i])return S(`${n}`),void S(`todo:subcmd:${i}`);n=p[i].usage?p[i].usage:n,c=p[i].version?p[i].version:c,p=p[i]?p[i]:()=>{}}let g=t.length<=s;if(e.enableZeroOption&&(g=t.length<s),p.enableZeroOption&&(g=t.length<s),g)return S(`${n}`),void S("error:invalid argv length");const b=function(t){let e=[],n=t;const s=[];t.includes("--")&&(e=t.slice(t.indexOf("--")+1),n=t.slice(0,t.indexOf("--")));const o=[];for(let t=0;t<n.length;t++){const e=n[t-1],i=n[t],r=n[t+1],l=r&&!/^--.+/.test(r)&&!/^-.+/.test(r),c=t=>{o.push([t,!l||r])};if(/^--.+=/.test(i)||/^-.=/.test(i))o.push(i.split("="));else if(/^-[^-].*/.test(i)){let t=i;if(t.includes("=")){const e=t.indexOf("=");o.push([t.slice(e-1,e),t.slice(e+1,e+2)]),t=t.slice(0,e-1)+t.slice(e+2)}for(const e of t.slice(1).split("").slice(0,-1))o.push([e,!0]);c(t[t.length-1])}else if(/^--.+/.test(i)||/^-.+/.test(i))c(i);else{let t=o.find((t=>t[0]===e));if(!t&&/^-./.test(e)){const n=e[e.length-1];t=o.find((t=>t[0]===n))}t||s.push(i)}}const i={};for(const t of o){let e=t[0].replace(/^-{1,2}/g,""),n=t[1];e.startsWith("no-")&&[void 0,!0].includes(n)&&(e=e.slice(3),n=!1),i[e]=w(n)}return{flags:i,_:s.map((t=>w(t))),extras:e.map((t=>w(t)))}}(t.slice(s)),m=b.flags;if((m.debugArgs||m.da)&&S(b),m.version||m.v)S(`${a} version:${c}`);else{if(!m.help&&!m.h)return e.notOnlyFlags||p.notOnlyFlags?p(b):p(m);S(`${n}`)}}};((t={})=>e=>(t.option&&(e.option={...e.option,...t.option}),"version,ns,autoSubCmd,autoSubNs".split(",").forEach((n=>{t[n]&&(e.option[n]=t[n])})),e.entry(t),e))(g)($),$.run(process.argv)}));
