/**
  * pkgsInfo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("node:fs");
/**
  * extendString v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
/**
  * jsonStreamIo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
class e{constructor(t,e){this.init(t,e)}async read(e={}){const{file:a}=this;let n,o;try{n=t.createReadStream(a.name),o=await(r=n,new Promise(((t,e)=>{let a="";r.on("data",(t=>{a+=t.toString()})).on("end",(()=>{t(a)})).on("error",e)}))),o=JSON.parse(o)}catch(t){o=e}
/**
  * streamIo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
var r;return a.data=o,o}async write(e){const{file:a,option:n}=this;let o,r=e;try{o=t.createWriteStream(a.name),e?a.data=e:r=a.data,await function({stream:t,data:e}){return new Promise(((a,n)=>{t.write(e,"utf-8"),t.end(),t.on("finish",(()=>{a(e)})).on("error",n)}))}({stream:o,data:JSON.stringify(r,null,2)})}catch(t){}}init(t="package.json",e={}){this.file={name:t,data:e},this.option={}}new(...t){return new e(...t)}}const a=new e;
/**
  * chainTask v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */async function n(t){const e=[];let a=Promise.resolve(null);for(let n=0;n<t.length;n++){const o=t[n];a=a.then((async t=>(e[n]=await o(),e[n]))).catch(console.log)}return await a,e}const{log:o}=console;async function r(e={}){const n={wkd:"./private-pkgs/noop",...e},o=function(t,e={}){let a=function(t){const e=t.split(/\/?\\|\//);return e[e.length-1]}(t);const n={trim:!0,...e};return n.trim&&(a=a.trim()),n.camelize&&(a=(o=a,o.replace(/(?:^\w|[A-Z_-]|\b\w)/g,((t,e)=>{let a="";return a=t.replace(/[-_]+/g," "),a=0!==e?a.replace(/[A-Z]/," $&"):a,0===e?a.toUpperCase():a.toLowerCase()})).replace(/\s+/g," ")).replace(/(?:^\w|[A-Z]|\b\w)/g,((t,e)=>0===e?t.toLowerCase():t.toUpperCase())).replace(/\s+/g,"")),a;var o}(n.wkd),r=function(t,e="/"){const a=t.split(/\/?\\|\//);return a.slice(0,a.length-1).join(e)}(n.wkd);const s=`${r}/${o}/package.json`;a.init(s);const i=await a.read({}),{name:c,description:l}=i;let p=[],w=[];return[`${r}/${o}/package.json`,`${r}/${o}/src/index.js`].filter((e=>t.existsSync(e))).forEach((e=>{const{modifiedAt:a,createdAt:n}=function(e){const a=t.statSync(e),{birthtime:n,mtime:o,ctime:r}=a;let s=[o,r];return s=s.sort(((t,e)=>new Date(e)-new Date(t))),{modifiedAt:s[0],createdAt:n}}(e);p.push(a),w.push(n)})),p=p.sort(((t,e)=>new Date(e)-new Date(t))),w=w.sort(((t,e)=>new Date(t)-new Date(e))),[p]=p,[w]=w,{name:c,description:l,created_at:w,modified_at:p,loc:s}}async function s(e={}){const a={packagesLoc:["packages"],split:",",...e};let n=(Array.isArray(a.packagesLoc)?a.packagesLoc:a.packagesLoc.split(a.split)).map((e=>t.readdirSync(e).map((t=>({wkd:`${e}/${t}`,libname:t,packagesLoc:e}))))).flat(1/0);return n=n.filter((e=>t.statSync(e.wkd).isDirectory())),n}function i(t,e){const a={};return t.forEach((t=>{const{name:e}=t;a[e]=t})),e.forEach((t=>{const{name:e}=t;a[e]?a[e]={...a[e],...t}:a[e]=t})),Object.values(a)}exports.codePkgsInfo=async function(t={}){let e,c,l,p,w;e=await s(t),c=e.map((t=>async()=>await r(t))),l=await n(c),p=t.storeAt?t.storeAt:"pkgs-info.json",a.init(p),w=await a.read([]);const u=i(l,w);await a.write(u),o(`[info] out: ${p}`)},exports.pullPkgsInfo=async function(t={}){let e,c,l,p,w;e=await s(t),c=e.map((t=>async()=>await r(t))),l=await n(c),p=t.storeAt?t.storeAt:"pkgs-info.json",a.init(p),w=await a.read([]);const u=i(w,l);await a.write(u),o(`[info] out: ${p}`)},exports.pushPkgsInfo=async function(t={}){let e,r,s;s=t.storeAt?t.storeAt:"pkgs-info.json",a.init(s),r=await a.read([]),e=r.map((t=>async()=>{a.init(t.loc);let e=await a.read({});e.description=t.description,await a.write(e),e=null})),o(`[info] out: ${s}`),await n(e)},exports.putPkgsInfo=function(t,e,a,n){return n.some((e=>e.name===t))?n.forEach((n=>{n.name===t&&(n[e]=a)})):n.push({name:t,[`${e}`]:a}),n};
