/**
  * tesPkgFile v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("node:child_process"),t=require("node:fs");function n(e){
/**
  * extendString v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
return function(e){return e.replace(/(?:^\w|[A-Z_-]|\b\w)/g,((e,t)=>{let n="";return n=e.replace(/[-_]+/g," "),n=0!==t?n.replace(/[A-Z]/," $&"):n,0===t?n.toUpperCase():n.toLowerCase()})).replace(/\s+/g," ")}(e).replace(/(?:^\w|[A-Z]|\b\w)/g,((e,t)=>0===t?e.toLowerCase():e.toUpperCase())).replace(/\s+/g,"")}
/**
  * cliParam v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */function o(e,t={}){let o={};const s=Object.keys(e).map((t=>e[t])),i={slim:!0,modeStyle:"cli",...t};"string"===i.mode&&(i.slim=!0);for(let e=0;e<s.length;e+=1){const t=s[e],{name:a,type:r,value:c,desc:l}=t,[p,u]=a.split(/,/).map((e=>e.trim().replace(/^-*/gi,""))),d=p.length>1?p:u;if(d){if(i.noAutoCamelize||(o[n(d)]=c),i.slim)continue;o[d]=c}o[p]=c}return"string"===i.mode&&(o=function(e,t){const n={modeStyle:"cli",...t};let o="";return"string"===n.mode&&"cli"===n.modeStyle&&(o=Object.keys(e).map((t=>t.length>1?`--${t}=${e[t]}`:`-${t}=${e[t]}`)).join(" ")),"string"===n.mode&&"httpquery"===n.modeStyle&&(o=Object.keys(e).map((t=>`${t}=${e[t]}`)).join("&")),"string"===n.mode&&"swithoption"===n.modeStyle&&(o=Object.keys(e).map((t=>`${t}=${e[t]}`)).join(";")),o}(o,i)),o}function s(e,t={}){return o(e,t)}function i(e,t={}){let o;const{entrys:s}=t;return o=e.flags||s&&s.notOnlyFlags?e.flags:e,function(e={},t={}){const o={slim:!0,...t};return o.noAutoCamelize||Object.keys(e).forEach((t=>{const s=n(t);s!==t&&(e[s]=e[t],o.slim&&delete e[t])})),e}(o,t)}
/**
  * runBash v0.0.3
  * (c) 2018-2022 ymc
  * @license MIT
  */function a(e){return e.split(/\r?\n/).map((e=>e.trim())).filter((e=>e)).join("\n")}const r=(t,n,o)=>new Promise(((s,i)=>{o||(o=n,n=t,t="");const r=((e,t=" ")=>Array.isArray(e)?e.join(t):e)(n);(o.exec?o.exec:e.exec)(`${t=t?`${t} ${r}`:`${r}`}`,o,((e,t,n)=>{const{fixUnreadbleCode:r}=o;if(r){const{iconvDesEncoding:e,iconvSrcEncoding:s}=o;t&&(t=r(t,e,s)),n&&(n=r(n,e,s))}e&&o.exitWhenErr&&i(e),o.noTrimOut||(t=a(t),n=a(n)),o.rejectStderr&&(n&&i(e),s(t)),s({stdout:t,stderr:n})}))})),c={exec:e.exec};
/**
  * jsonStreamIo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
class l{constructor(e,t){this.init(e,t)}async read(e={}){const{file:n}=this;let o,s;try{o=t.createReadStream(n.name),s=await(i=o,new Promise(((e,t)=>{let n="";i.on("data",(e=>{n+=e.toString()})).on("end",(()=>{e(n)})).on("error",t)}))),s=JSON.parse(s)}catch(t){s=e}
/**
  * streamIo v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
var i;return n.data=s,s}async write(e){const{file:n,option:o}=this;let s,i=e;try{s=t.createWriteStream(n.name),e?n.data=e:i=n.data,await function({stream:e,data:t}){return new Promise(((n,o)=>{e.write(t,"utf-8"),e.end(),e.on("finish",(()=>{n(t)})).on("error",o)}))}({stream:s,data:JSON.stringify(i,null,2)})}catch(e){}}init(e="package.json",t={}){this.file={name:e,data:t},this.option={}}new(...e){return new l(...e)}}const p=new l,{log:u}=console;function d(){return[{name:"-h,--help",type:"boolean",value:!1,desc:"info help"},{name:"-v,--version",type:"string",value:"1.0.0",desc:"info version"},{name:"--pkg-loc",type:"string",value:"./packages/noop",desc:"the location of pkg"},{name:"--jest-cmd",type:"string",value:"npx jest",desc:"the cmd of jest"},{name:"--jest-cnf-loc",type:"string",value:"test/unit/jest.config.json",desc:"the location of jest config"},{name:"--run-cmd",type:"boolean",value:!1,desc:"run jest cmd or not"}]}exports.main=async function(e={}){const t={...s([{name:"-h,--help",type:"boolean",value:!1,desc:"info help"},{name:"-v,--version",type:"string",value:"1.0.0",desc:"info version"},{name:"--pkg-loc",type:"string",value:"./packages/noop",desc:"the location of pkg"},{name:"--jest-cmd",type:"string",value:"npx jest",desc:"the cmd of jest"},{name:"--jest-cnf-loc",type:"string",value:"test/unit/jest.config.json",desc:"the location of jest config"},{name:"--run-cmd",type:"boolean",value:!1,desc:"run jest cmd or not"}]),...i(e)};u(`[task] run unit test for pkg ${t.pkgLoc}`);const n=`${t.jestCmd} ${t.pkgLoc} --config=${t.jestCnfLoc} --color --passWithNoTests`;if(t.runCmd){const e=await async function(e,t){u(`[info] run cmd: ${e}`);const{stderr:n,stdout:o}=await r(e,t);n&&u(n),u(o);const s="todo,passing,fail".split(",");let[,i]=s;return n&&/FAIL/g.test(n)?[,,i]=s:o.indexOf("No tests found, exiting with code 0")>=0&&([i]=s),u(`[info] ${i} unit test`),function(e,t="done",n="fail"){let o=n;return!0&&(o=t),o}(0,i,"fail")}(n,c);await async function(e={}){const t={key:"lin_state",state:"todo",storeAt:"pkgs-info.json",...e};let n=t.pkgLoc;u("[info] set lint state in store"),p.init(`${t.pkgLoc}/package.json`);const o=await p.read({});n=t.storeAt,p.init(`${n}`);const s=await p.read([]);var i,a,r,c;i=o.name,a=t.key,r=t.state,(c=s).some((e=>e.name===i))?c.forEach((e=>{e.name===i&&(e[a]=r)})):c.push({name:i,[`${a}`]:r}),await p.write(s),u(`[info] out: ${n}`)}({pkgLoc:t.pkgLoc,key:"tes_state",state:e,storeAt:"pkgs-info.json"})}return n},exports.param=d;
