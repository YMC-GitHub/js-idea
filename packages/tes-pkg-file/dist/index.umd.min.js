/**
  * tesPkgFile v1.0.0
  * (c) 2018-2022 ymc
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("node:child_process"),require("node:fs")):"function"==typeof define&&define.amd?define(["exports","node:child_process","node:fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["tes-pkg-file"]={},e.node_child_process,e.node_fs)}(this,(function(e,t,n){"use strict";
/**
    * cliPresetParam v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */function o(e){
/**
    * extendString v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */
return function(e){return e.replace(/(?:^\w|[A-Z_-]|\b\w)/g,((e,t)=>{let n="";return n=e.replace(/[-_]+/g," "),n=0!==t?n.replace(/[A-Z]/," $&"):n,0===t?n.toUpperCase():n.toLowerCase()})).replace(/\s+/g," ")}(e).replace(/(?:^\w|[A-Z]|\b\w)/g,((e,t)=>0===t?e.toLowerCase():e.toUpperCase())).replace(/\s+/g,"")}
/**
    * cliParam v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */function s(e,t={}){let n={};const s=Object.keys(e).map((t=>e[t])),i={slim:!0,modeStyle:"cli",...t};"string"===i.mode&&(i.slim=!0);for(let e=0;e<s.length;e+=1){const t=s[e],{name:a,type:r,value:c,desc:l}=t,[d,f]=a.split(/,/).map((e=>e.trim().replace(/^-*/gi,""))),p=d.length>1?d:f;if(p){if(i.noAutoCamelize||(n[o(p)]=c),i.slim)continue;n[p]=c}n[d]=c}return"string"===i.mode&&(n=function(e,t){const n={modeStyle:"cli",...t};let o="";return"string"===n.mode&&"cli"===n.modeStyle&&(o=Object.keys(e).map((t=>t.length>1?`--${t}=${e[t]}`:`-${t}=${e[t]}`)).join(" ")),"string"===n.mode&&"httpquery"===n.modeStyle&&(o=Object.keys(e).map((t=>`${t}=${e[t]}`)).join("&")),"string"===n.mode&&"swithoption"===n.modeStyle&&(o=Object.keys(e).map((t=>`${t}=${e[t]}`)).join(";")),o}(n,i)),n}function i(e,t={}){return s(e,t)}function a(e,t={}){let n;const{entrys:s}=t;return n=e.flags||s&&s.notOnlyFlags?e.flags:e,function(e={},t={}){const n={slim:!0,...t};return n.noAutoCamelize||Object.keys(e).forEach((t=>{const s=o(t);s!==t&&(e[s]=e[t],n.slim&&delete e[t])})),e}(n,t)}
/**
    * runBash v0.0.3
    * (c) 2018-2022 ymc
    * @license MIT
    */function r(e){return e.split(/\r?\n/).map((e=>e.trim())).filter((e=>e)).join("\n")}const c=(e,n,o)=>new Promise(((s,i)=>{o||(o=n,n=e,e="");const a=((e,t=" ")=>Array.isArray(e)?e.join(t):e)(n);(o.exec?o.exec:t.exec)(`${e=e?`${e} ${a}`:`${a}`}`,o,((e,t,n)=>{const{fixUnreadbleCode:a}=o;if(a){const{iconvDesEncoding:e,iconvSrcEncoding:s}=o;t&&(t=a(t,e,s)),n&&(n=a(n,e,s))}e&&o.exitWhenErr&&i(e),o.noTrimOut||(t=r(t),n=r(n)),o.rejectStderr&&(n&&i(e),s(t)),s({stdout:t,stderr:n})}))})),l={exec:t.exec};
/**
    * jsonStreamIo v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */
class d{constructor(e,t){this.init(e,t)}async read(e={}){const{file:t}=this;let o,s;try{o=n.createReadStream(t.name),s=await(i=o,new Promise(((e,t)=>{let n="";i.on("data",(e=>{n+=e.toString()})).on("end",(()=>{e(n)})).on("error",t)}))),s=JSON.parse(s)}catch(t){s=e}
/**
    * streamIo v1.0.0
    * (c) 2018-2022 ymc
    * @license MIT
    */
var i;return t.data=s,s}async write(e){const{file:t,option:o}=this;let s,i=e;try{s=n.createWriteStream(t.name),e?t.data=e:i=t.data,await function({stream:e,data:t}){return new Promise(((n,o)=>{e.write(t,"utf-8"),e.end(),e.on("finish",(()=>{n(t)})).on("error",o)}))}({stream:s,data:JSON.stringify(i,null,2)})}catch(e){}}init(e="package.json",t={}){this.file={name:e,data:t},this.option={}}new(...e){return new d(...e)}}const f=new d,{log:p}=console;function u(){return[{name:"-h,--help",type:"boolean",value:!1,desc:"info help"},{name:"-v,--version",type:"string",value:"1.0.0",desc:"info version"},{name:"--pkg-loc",type:"string",value:"./packages/noop",desc:"the location of pkg"},{name:"--jest-cmd",type:"string",value:"npx jest",desc:"the cmd of jest"},{name:"--jest-cnf-loc",type:"string",value:"test/unit/jest.config.json",desc:"the location of jest config"},{name:"--run-cmd",type:"boolean",value:!1,desc:"run jest cmd or not"}]}e.main=async function(e={}){const t={...i([{name:"-h,--help",type:"boolean",value:!1,desc:"info help"},{name:"-v,--version",type:"string",value:"1.0.0",desc:"info version"},{name:"--pkg-loc",type:"string",value:"./packages/noop",desc:"the location of pkg"},{name:"--jest-cmd",type:"string",value:"npx jest",desc:"the cmd of jest"},{name:"--jest-cnf-loc",type:"string",value:"test/unit/jest.config.json",desc:"the location of jest config"},{name:"--run-cmd",type:"boolean",value:!1,desc:"run jest cmd or not"}]),...a(e)};p(`[task] run unit test for pkg ${t.pkgLoc}`);const n=`${t.jestCmd} ${t.pkgLoc} --config=${t.jestCnfLoc} --color --passWithNoTests`;if(t.runCmd){const e=await async function(e,t){p(`[info] run cmd: ${e}`);const{stderr:n,stdout:o}=await c(e,t);n&&p(n),p(o);const s="todo,passing,fail".split(",");let[,i]=s;return n&&/FAIL/g.test(n)?[,,i]=s:o.indexOf("No tests found, exiting with code 0")>=0&&([i]=s),p(`[info] ${i} unit test`),function(e,t="done",n="fail"){let o=n;return!0&&(o=t),o}(0,i,"fail")}(n,l);await async function(e={}){const t={key:"lin_state",state:"todo",storeAt:"pkgs-info.json",...e};let n=t.pkgLoc;p("[info] set lint state in store"),f.init(`${t.pkgLoc}/package.json`);const o=await f.read({});n=t.storeAt,f.init(`${n}`);const s=await f.read([]);var i,a,r,c;i=o.name,a=t.key,r=t.state,(c=s).some((e=>e.name===i))?c.forEach((e=>{e.name===i&&(e[a]=r)})):c.push({name:i,[`${a}`]:r}),await f.write(s),p(`[info] out: ${n}`)}({pkgLoc:t.pkgLoc,key:"tes_state",state:e,storeAt:"pkgs-info.json"})}return n},e.param=u,Object.defineProperty(e,"__esModule",{value:!0})}));
